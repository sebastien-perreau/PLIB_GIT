/*********************************************************************
*	Author : Sébastien PERREAU
*
*	Revision history	:
*		21/03/2019		- Initial release
* 
*********************************************************************/

#include "../PLIB.h"

static const uint32_t ws2812b_mapping[] = 
{
    0x88888888, 0xe8888888, 0x8e888888, 0xee888888, 0x88e88888, 0xe8e88888, 0x8ee88888, 0xeee88888, 0x888e8888, 0xe88e8888, 0x8e8e8888, 0xee8e8888, 0x88ee8888, 0xe8ee8888, 0x8eee8888, 0xeeee8888, 
    0x8888e888, 0xe888e888, 0x8e88e888, 0xee88e888, 0x88e8e888, 0xe8e8e888, 0x8ee8e888, 0xeee8e888, 0x888ee888, 0xe88ee888, 0x8e8ee888, 0xee8ee888, 0x88eee888, 0xe8eee888, 0x8eeee888, 0xeeeee888, 
    0x88888e88, 0xe8888e88, 0x8e888e88, 0xee888e88, 0x88e88e88, 0xe8e88e88, 0x8ee88e88, 0xeee88e88, 0x888e8e88, 0xe88e8e88, 0x8e8e8e88, 0xee8e8e88, 0x88ee8e88, 0xe8ee8e88, 0x8eee8e88, 0xeeee8e88, 
    0x8888ee88, 0xe888ee88, 0x8e88ee88, 0xee88ee88, 0x88e8ee88, 0xe8e8ee88, 0x8ee8ee88, 0xeee8ee88, 0x888eee88, 0xe88eee88, 0x8e8eee88, 0xee8eee88, 0x88eeee88, 0xe8eeee88, 0x8eeeee88, 0xeeeeee88, 
    0x888888e8, 0xe88888e8, 0x8e8888e8, 0xee8888e8, 0x88e888e8, 0xe8e888e8, 0x8ee888e8, 0xeee888e8, 0x888e88e8, 0xe88e88e8, 0x8e8e88e8, 0xee8e88e8, 0x88ee88e8, 0xe8ee88e8, 0x8eee88e8, 0xeeee88e8, 
    0x8888e8e8, 0xe888e8e8, 0x8e88e8e8, 0xee88e8e8, 0x88e8e8e8, 0xe8e8e8e8, 0x8ee8e8e8, 0xeee8e8e8, 0x888ee8e8, 0xe88ee8e8, 0x8e8ee8e8, 0xee8ee8e8, 0x88eee8e8, 0xe8eee8e8, 0x8eeee8e8, 0xeeeee8e8, 
    0x88888ee8, 0xe8888ee8, 0x8e888ee8, 0xee888ee8, 0x88e88ee8, 0xe8e88ee8, 0x8ee88ee8, 0xeee88ee8, 0x888e8ee8, 0xe88e8ee8, 0x8e8e8ee8, 0xee8e8ee8, 0x88ee8ee8, 0xe8ee8ee8, 0x8eee8ee8, 0xeeee8ee8, 
    0x8888eee8, 0xe888eee8, 0x8e88eee8, 0xee88eee8, 0x88e8eee8, 0xe8e8eee8, 0x8ee8eee8, 0xeee8eee8, 0x888eeee8, 0xe88eeee8, 0x8e8eeee8, 0xee8eeee8, 0x88eeeee8, 0xe8eeeee8, 0x8eeeeee8, 0xeeeeeee8, 
    0x8888888e, 0xe888888e, 0x8e88888e, 0xee88888e, 0x88e8888e, 0xe8e8888e, 0x8ee8888e, 0xeee8888e, 0x888e888e, 0xe88e888e, 0x8e8e888e, 0xee8e888e, 0x88ee888e, 0xe8ee888e, 0x8eee888e, 0xeeee888e, 
    0x8888e88e, 0xe888e88e, 0x8e88e88e, 0xee88e88e, 0x88e8e88e, 0xe8e8e88e, 0x8ee8e88e, 0xeee8e88e, 0x888ee88e, 0xe88ee88e, 0x8e8ee88e, 0xee8ee88e, 0x88eee88e, 0xe8eee88e, 0x8eeee88e, 0xeeeee88e, 
    0x88888e8e, 0xe8888e8e, 0x8e888e8e, 0xee888e8e, 0x88e88e8e, 0xe8e88e8e, 0x8ee88e8e, 0xeee88e8e, 0x888e8e8e, 0xe88e8e8e, 0x8e8e8e8e, 0xee8e8e8e, 0x88ee8e8e, 0xe8ee8e8e, 0x8eee8e8e, 0xeeee8e8e, 
    0x8888ee8e, 0xe888ee8e, 0x8e88ee8e, 0xee88ee8e, 0x88e8ee8e, 0xe8e8ee8e, 0x8ee8ee8e, 0xeee8ee8e, 0x888eee8e, 0xe88eee8e, 0x8e8eee8e, 0xee8eee8e, 0x88eeee8e, 0xe8eeee8e, 0x8eeeee8e, 0xeeeeee8e, 
    0x888888ee, 0xe88888ee, 0x8e8888ee, 0xee8888ee, 0x88e888ee, 0xe8e888ee, 0x8ee888ee, 0xeee888ee, 0x888e88ee, 0xe88e88ee, 0x8e8e88ee, 0xee8e88ee, 0x88ee88ee, 0xe8ee88ee, 0x8eee88ee, 0xeeee88ee, 
    0x8888e8ee, 0xe888e8ee, 0x8e88e8ee, 0xee88e8ee, 0x88e8e8ee, 0xe8e8e8ee, 0x8ee8e8ee, 0xeee8e8ee, 0x888ee8ee, 0xe88ee8ee, 0x8e8ee8ee, 0xee8ee8ee, 0x88eee8ee, 0xe8eee8ee, 0x8eeee8ee, 0xeeeee8ee, 
    0x88888eee, 0xe8888eee, 0x8e888eee, 0xee888eee, 0x88e88eee, 0xe8e88eee, 0x8ee88eee, 0xeee88eee, 0x888e8eee, 0xe88e8eee, 0x8e8e8eee, 0xee8e8eee, 0x88ee8eee, 0xe8ee8eee, 0x8eee8eee, 0xeeee8eee, 
    0x8888eeee, 0xe888eeee, 0x8e88eeee, 0xee88eeee, 0x88e8eeee, 0xe8e8eeee, 0x8ee8eeee, 0xeee8eeee, 0x888eeeee, 0xe88eeeee, 0x8e8eeeee, 0xee8eeeee, 0x88eeeeee, 0xe8eeeeee, 0x8eeeeeee, 0xeeeeeeee
};

static const uint32_t sk6812rgbw_mapping[256] = 
{
    0x88888888, 0xc8888888, 0x8c888888, 0xcc888888, 0x88c88888, 0xc8c88888, 0x8cc88888, 0xccc88888, 0x888c8888, 0xc88c8888, 0x8c8c8888, 0xcc8c8888, 0x88cc8888, 0xc8cc8888, 0x8ccc8888, 0xcccc8888, 
    0x8888c888, 0xc888c888, 0x8c88c888, 0xcc88c888, 0x88c8c888, 0xc8c8c888, 0x8cc8c888, 0xccc8c888, 0x888cc888, 0xc88cc888, 0x8c8cc888, 0xcc8cc888, 0x88ccc888, 0xc8ccc888, 0x8cccc888, 0xccccc888, 
    0x88888c88, 0xc8888c88, 0x8c888c88, 0xcc888c88, 0x88c88c88, 0xc8c88c88, 0x8cc88c88, 0xccc88c88, 0x888c8c88, 0xc88c8c88, 0x8c8c8c88, 0xcc8c8c88, 0x88cc8c88, 0xc8cc8c88, 0x8ccc8c88, 0xcccc8c88, 
    0x8888cc88, 0xc888cc88, 0x8c88cc88, 0xcc88cc88, 0x88c8cc88, 0xc8c8cc88, 0x8cc8cc88, 0xccc8cc88, 0x888ccc88, 0xc88ccc88, 0x8c8ccc88, 0xcc8ccc88, 0x88cccc88, 0xc8cccc88, 0x8ccccc88, 0xcccccc88, 
    0x888888c8, 0xc88888c8, 0x8c8888c8, 0xcc8888c8, 0x88c888c8, 0xc8c888c8, 0x8cc888c8, 0xccc888c8, 0x888c88c8, 0xc88c88c8, 0x8c8c88c8, 0xcc8c88c8, 0x88cc88c8, 0xc8cc88c8, 0x8ccc88c8, 0xcccc88c8, 
    0x8888c8c8, 0xc888c8c8, 0x8c88c8c8, 0xcc88c8c8, 0x88c8c8c8, 0xc8c8c8c8, 0x8cc8c8c8, 0xccc8c8c8, 0x888cc8c8, 0xc88cc8c8, 0x8c8cc8c8, 0xcc8cc8c8, 0x88ccc8c8, 0xc8ccc8c8, 0x8cccc8c8, 0xccccc8c8, 
    0x88888cc8, 0xc8888cc8, 0x8c888cc8, 0xcc888cc8, 0x88c88cc8, 0xc8c88cc8, 0x8cc88cc8, 0xccc88cc8, 0x888c8cc8, 0xc88c8cc8, 0x8c8c8cc8, 0xcc8c8cc8, 0x88cc8cc8, 0xc8cc8cc8, 0x8ccc8cc8, 0xcccc8cc8, 
    0x8888ccc8, 0xc888ccc8, 0x8c88ccc8, 0xcc88ccc8, 0x88c8ccc8, 0xc8c8ccc8, 0x8cc8ccc8, 0xccc8ccc8, 0x888cccc8, 0xc88cccc8, 0x8c8cccc8, 0xcc8cccc8, 0x88ccccc8, 0xc8ccccc8, 0x8cccccc8, 0xccccccc8, 
    0x8888888c, 0xc888888c, 0x8c88888c, 0xcc88888c, 0x88c8888c, 0xc8c8888c, 0x8cc8888c, 0xccc8888c, 0x888c888c, 0xc88c888c, 0x8c8c888c, 0xcc8c888c, 0x88cc888c, 0xc8cc888c, 0x8ccc888c, 0xcccc888c, 
    0x8888c88c, 0xc888c88c, 0x8c88c88c, 0xcc88c88c, 0x88c8c88c, 0xc8c8c88c, 0x8cc8c88c, 0xccc8c88c, 0x888cc88c, 0xc88cc88c, 0x8c8cc88c, 0xcc8cc88c, 0x88ccc88c, 0xc8ccc88c, 0x8cccc88c, 0xccccc88c, 
    0x88888c8c, 0xc8888c8c, 0x8c888c8c, 0xcc888c8c, 0x88c88c8c, 0xc8c88c8c, 0x8cc88c8c, 0xccc88c8c, 0x888c8c8c, 0xc88c8c8c, 0x8c8c8c8c, 0xcc8c8c8c, 0x88cc8c8c, 0xc8cc8c8c, 0x8ccc8c8c, 0xcccc8c8c, 
    0x8888cc8c, 0xc888cc8c, 0x8c88cc8c, 0xcc88cc8c, 0x88c8cc8c, 0xc8c8cc8c, 0x8cc8cc8c, 0xccc8cc8c, 0x888ccc8c, 0xc88ccc8c, 0x8c8ccc8c, 0xcc8ccc8c, 0x88cccc8c, 0xc8cccc8c, 0x8ccccc8c, 0xcccccc8c, 
    0x888888cc, 0xc88888cc, 0x8c8888cc, 0xcc8888cc, 0x88c888cc, 0xc8c888cc, 0x8cc888cc, 0xccc888cc, 0x888c88cc, 0xc88c88cc, 0x8c8c88cc, 0xcc8c88cc, 0x88cc88cc, 0xc8cc88cc, 0x8ccc88cc, 0xcccc88cc, 
    0x8888c8cc, 0xc888c8cc, 0x8c88c8cc, 0xcc88c8cc, 0x88c8c8cc, 0xc8c8c8cc, 0x8cc8c8cc, 0xccc8c8cc, 0x888cc8cc, 0xc88cc8cc, 0x8c8cc8cc, 0xcc8cc8cc, 0x88ccc8cc, 0xc8ccc8cc, 0x8cccc8cc, 0xccccc8cc, 
    0x88888ccc, 0xc8888ccc, 0x8c888ccc, 0xcc888ccc, 0x88c88ccc, 0xc8c88ccc, 0x8cc88ccc, 0xccc88ccc, 0x888c8ccc, 0xc88c8ccc, 0x8c8c8ccc, 0xcc8c8ccc, 0x88cc8ccc, 0xc8cc8ccc, 0x8ccc8ccc, 0xcccc8ccc, 
    0x8888cccc, 0xc888cccc, 0x8c88cccc, 0xcc88cccc, 0x88c8cccc, 0xc8c8cccc, 0x8cc8cccc, 0xccc8cccc, 0x888ccccc, 0xc88ccccc, 0x8c8ccccc, 0xcc8ccccc, 0x88cccccc, 0xc8cccccc, 0x8ccccccc, 0xcccccccc
};

void pink_lady_deamon(PINK_LADY_PARAMS *var)
{
    if (!var->is_init_done)
    {
        spi_init(   var->spi_id, 
                    NULL, 
                    IRQ_NONE, 
                    ((var->led_model & SK6812RGBW_INDICE_MASK) > 0) ? SK6812RGBW_TIMING : WS2812B_TIMING, 
                    SPI_CONF_MSTEN | SPI_CONF_FRMPOL_LOW | SPI_CONF_SMP_MIDDLE | SPI_CONF_MODE8 | SPI_CONF_CKP_HIGH | SPI_CONF_CKE_OFF);
        
        dma_init(   var->dma_id, 
                    NULL, 
                    DMA_CONT_PRIO_3 | DMA_CONT_AUTO_ENABLE, 
                    DMA_INT_NONE, 
                    DMA_EVT_START_TRANSFER_ON_IRQ, 
                    spi_get_tx_irq(var->spi_id), 
                    0xff);
        
        var->p_led_model_mapping = ((var->led_model & SK6812RGBW_INDICE_MASK) > 0) ? (uint32_t *)sk6812rgbw_mapping : (uint32_t *)ws2812b_mapping;
        var->dma_params.dst_start_addr = (void *) spi_get_tx_reg(var->spi_id);       
        dma_set_transfer(var->dma_id, &var->dma_params, true);
        var->is_init_done = true;
    }
    else
    {        
        
        if ((var->led_model & SK6812RGBW_INDICE_MASK) > 0)
        {
            var->p_buffer[0 + 4*var->ind_update_tx_buffer] = var->p_led_model_mapping[var->p_led[var->ind_update_tx_buffer].green];
            var->p_buffer[1 + 4*var->ind_update_tx_buffer] = var->p_led_model_mapping[var->p_led[var->ind_update_tx_buffer].red];
            var->p_buffer[2 + 4*var->ind_update_tx_buffer] = var->p_led_model_mapping[var->p_led[var->ind_update_tx_buffer].blue];
            var->p_buffer[3 + 4*var->ind_update_tx_buffer] = var->p_led_model_mapping[var->p_led[var->ind_update_tx_buffer].white];
        }
        else if ((var->led_model & WS2812B_INDICE_MASK) > 0)
        {
            var->p_buffer[0 + 3*var->ind_update_tx_buffer] = var->p_led_model_mapping[var->p_led[var->ind_update_tx_buffer].green];
            var->p_buffer[1 + 3*var->ind_update_tx_buffer] = var->p_led_model_mapping[var->p_led[var->ind_update_tx_buffer].red];
            var->p_buffer[2 + 3*var->ind_update_tx_buffer] = var->p_led_model_mapping[var->p_led[var->ind_update_tx_buffer].blue];
        }
        
        if (++var->ind_update_tx_buffer >= var->number_of_leds)
        {
            var->ind_update_tx_buffer = 0;
        }
    }
}
